<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automata for Lexical Analysis & Plagiarism Detection</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="bg-light">
 
</div>

  <div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
      <h1 class="fw-bold text-primary">
        <i class="bi bi-diagram-3"></i> Automata for Lexical Analysis & Plagiarism Detection
      </h1>
      <p class="text-muted">Upload a file or paste text to analyze.</p>
    </div>

    <!-- Upload Section -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-upload"></i> Upload Text, Word, or PDF File
      </div>
      <div class="card-body">
        <form id="fileForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="file_input" class="form-label">Select a file (.txt, .docx, .pdf)</label>
            <input class="form-control" type="file" id="file_input" accept=".txt,.pdf,.docx">
          </div>
        </form>
      </div>
    </div>

    <!-- Text Analysis Section -->
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <i class="bi bi-pencil-square"></i> Text Input for Analysis
      </div>
      <div class="card-body">
        <form id="analysisForm">
          <div class="mb-3">
            <label for="text_input" class="form-label">Enter or Paste Text</label>
            <textarea class="form-control" id="text_input" rows="8"
                      placeholder="Type, paste, or upload text here..."></textarea>
          </div>

          <div class="mb-3">
           <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-play-circle"></i> Run Analysis
          </button>
          </div>

         
        </form>
      </div>`
    </div>

    <!-- Result Section -->
    <div class="card shadow-sm mt-4 d-none" id="resultCard">
      <div class="card-header bg-dark text-white">
        <i class="bi bi-clipboard-check"></i> Analysis Result
      </div>
      <div class="card-body">
        <div id="resultOutput" class="p-3 bg-light border rounded"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

<script>
  $(document).ready(function () {
    console.log("‚úÖ Page Loaded");

    // --------------------------
    // üìÑ File Upload Handling
    // --------------------------
    $("#file_input").on("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const fileType = file.name.split('.').pop().toLowerCase();
      $("#text_input").val("Reading file... Please wait...");

      if (fileType === "txt") {
        const reader = new FileReader();
        reader.onload = e => $("#text_input").val(e.target.result);
        reader.readAsText(file);
      } else if (fileType === "pdf") {
        const reader = new FileReader();
        reader.onload = function () {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(async pdf => {
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(" ");
              fullText += pageText + "\n\n";
            }
            $("#text_input").val(fullText.trim());
          }).catch(err => $("#text_input").val("Error reading PDF: " + err.message));
        };
        reader.readAsArrayBuffer(file);
      } else if (fileType === "docx") {
        const reader = new FileReader();
        reader.onload = e => {
          mammoth.extractRawText({ arrayBuffer: e.target.result })
            .then(result => $("#text_input").val(result.value.trim()))
            .catch(err => $("#text_input").val("Error reading DOCX: " + err.message));
        };
        reader.readAsArrayBuffer(file);
      } else {
        $("#text_input").val("Unsupported file type. Please upload .txt, .pdf, or .docx.");
      }
    });

    // --------------------------
    // üöÄ Submit Analysis via Axios
    // --------------------------

    // Map helper function (same as CodePen)
    function scale(num, in_min, in_max, out_min, out_max) {
      return ((num - in_min) * (out_max - out_min)) / (in_max - in_min) + out_min;
    }

    // --------------------------
    // üöÄ Submit Analysis via Axios
    // --------------------------
    $("#analysisForm").on("submit", async function (e) {
      e.preventDefault();

      const textInput = $("#text_input").val().trim();
      const resultCard = $("#resultCard");
      const resultOutput = $("#resultOutput");

      if (!textInput) {
        alert("‚ö†Ô∏è Please enter or upload text before analyzing.");
        return;
      }

      // Show blur loader
      

      try {
        const response = await axios.post("/api/plagiarism", { text_input: textInput });
        const data = response.data;

        // Stop blur loader
        resultCard.removeClass("d-none");

        if (data.status === "success") {
          const result = data.result;
          const scoreValue = parseFloat(result.similarity_score.replace('%', '')) || 0;
          const badgeClass =
            scoreValue < 20 ? "bg-success" :
            scoreValue < 50 ? "bg-warning text-dark" :
            "bg-danger";

          const ui = `
            <div class="mb-3">
              <h5 class="fw-bold mb-2"><i class="bi bi-percent"></i> Similarity Score</h5>
              <div class="progress" style="height: 25px;">
                <div class="progress-bar ${badgeClass}" style="width: ${scoreValue}%;">
                  ${result.similarity_score}
                </div>
              </div>
            </div>

            <div class="mt-4">
              <h5 class="fw-bold"><i class="bi bi-graph-up-arrow"></i> Interpretation</h5>
              <span class="badge ${badgeClass} fs-6 p-2">${result.interpretation}</span>
            </div>

            <hr class="my-4">

            <div class="row text-center">
              <div class="col-md-6">
                <div class="card border-success shadow-sm mb-3">
                  <div class="card-header bg-success text-white fw-bold">User Text</div>
                  <div class="card-body">
                    <p><strong>Total Tokens:</strong> ${result.lexical_analysis.user.total_tokens}</p>
                    <p><strong>Unique Tokens:</strong> ${result.lexical_analysis.user.unique_tokens}</p>
                    <p><strong>Keyword Count:</strong> ${result.lexical_analysis.user.keyword_count}</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-primary shadow-sm mb-3">
                  <div class="card-header bg-primary text-white fw-bold">Reference Text</div>
                  <div class="card-body">
                    <p><strong>Total Tokens:</strong> ${result.lexical_analysis.reference.total_tokens}</p>
                    <p><strong>Unique Tokens:</strong> ${result.lexical_analysis.reference.unique_tokens}</p>
                    <p><strong>Keyword Count:</strong> ${result.lexical_analysis.reference.keyword_count}</p>
                  </div>
                </div>
              </div>
            </div>
          `;

          resultOutput.html(ui);
        } else {
          resultOutput.html(`<div class="alert alert-danger">‚ùå Error: ${data.message}</div>`);
        }
      } catch (err) {
        console.error(err);
        resultOutput.html(`<div class="alert alert-danger">üö® Request failed: ${err.message}</div>`);
      }
    });



  });
</script>

</body>
</html>
